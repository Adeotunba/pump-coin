<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>pump.coin ‚Äî Mint Wizard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Solana web3.js (IIFE for browsers) -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.js"></script>
  <!-- SPL Token (ESM) + Metaplex Token Metadata (ESM) -->
  <script type="module" id="spl-preload">
    export {};
  </script>
  <!-- JSZip + FileSaver for Launch Pack -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    .step-active { border-color: rgb(56 189 248); background: rgb(2 6 23 / 0.6); }
    .step-done   { border-color: rgb(16 185 129); }
    .btn { @apply px-4 py-2 rounded-xl font-semibold; }
    .btn-primary { @apply bg-sky-500 hover:bg-sky-400 text-black; }
    .btn-ghost { @apply border border-slate-700; }
    .btn-success { @apply bg-emerald-300 text-black; }
    .btn-warn { @apply bg-amber-300 text-black; }
    .btn-danger { @apply bg-rose-300 text-black; }
    .card { @apply bg-slate-900/40 border border-slate-800 rounded-2xl p-6; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-950 to-black text-slate-100">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
        pump<span class="text-sky-400">.coin</span> <span class="text-xs align-super">v0.9 ‚Äî step wizard</span>
      </h1>
      <div class="flex items-center gap-2">
        <select id="network" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm">
          <option value="devnet" selected>devnet</option>
          <option value="mainnet-beta">mainnet-beta</option>
        </select>
        <button id="connectBtn" class="btn btn-primary">Connect Phantom</button>
        <span id="addr" class="text-xs text-slate-400"></span>
      </div>
    </header>

    <!-- Stepper -->
    <nav class="grid grid-cols-1 md:grid-cols-5 gap-2 mt-6">
      <div id="nav-1" class="card step-active">
        <div class="text-xs uppercase text-slate-400">Step 1</div>
        <div class="font-semibold">Mint Token</div>
        <div class="text-xs text-slate-400">Create SPL token (devnet).</div>
      </div>
      <div id="nav-2" class="card">
        <div class="text-xs uppercase text-slate-400">Step 2</div>
        <div class="font-semibold">Metadata & Logo</div>
        <div class="text-xs text-slate-400">Save JSON + set on-chain.</div>
      </div>
      <div id="nav-3" class="card">
        <div class="text-xs uppercase text-slate-400">Step 3</div>
        <div class="font-semibold">Security</div>
        <div class="text-xs text-slate-400">Check/renounce mint auth.</div>
      </div>
      <div id="nav-4" class="card">
        <div class="text-xs uppercase text-slate-400">Step 4</div>
        <div class="font-semibold">Raydium Plan</div>
        <div class="text-xs text-slate-400">Exact LP math + checklist.</div>
      </div>
      <div id="nav-5" class="card">
        <div class="text-xs uppercase text-slate-400">Step 5</div>
        <div class="font-semibold">Marketing & Pack</div>
        <div class="text-xs text-slate-400">Tweets, TG, ZIP, affiliates.</div>
      </div>
    </nav>

    <!-- Steps -->
    <section id="step-1" class="card mt-6">
      <h2 class="text-xl font-semibold">Step 1 ‚Äî Mint Token</h2>
      <p class="text-sm text-slate-400">Creates an SPL token and mints the full supply to your wallet‚Äôs ATA. (Devnet only inside the app.)</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
        <label class="text-sm">Decimals
          <input id="ct_decimals" value="6" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" />
        </label>
        <label class="text-sm">Total Supply (tokens)
          <input id="ct_supply" value="1000000000" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" />
        </label>
        <label class="text-sm">Mint to (your ATA)
          <input id="ct_to" placeholder="auto = your wallet" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" disabled />
        </label>
      </div>
      <div class="mt-4 flex flex-wrap gap-3 items-center">
        <button id="ctBtn" class="btn btn-primary">Create Token (Devnet)</button>
        <span class="text-xs text-slate-400">Mainnet minting will be enabled after full audit.</span>
      </div>
      <div class="mt-3 text-sm">
        Mint Address: <span id="mintAddr" class="font-mono text-sky-300"></span>
      </div>
      <pre id="ct_out" class="hidden mt-3 bg-slate-950 border border-slate-800 rounded-xl p-3 overflow-x-auto"></pre>
      <div class="mt-4 flex justify-between">
        <span></span>
        <button id="next-1" class="btn btn-success">Next ‚Üí Metadata</button>
      </div>
    </section>

    <section id="step-2" class="card mt-6 hidden">
      <h2 class="text-xl font-semibold">Step 2 ‚Äî Metadata & Logo</h2>
      <p class="text-sm text-slate-400">Upload the logo, save metadata JSON on our server, then set the on-chain URI via Metaplex.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
        <label class="text-sm">Mint
          <input id="md_mint" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="Will auto-fill from Step 1" />
        </label>
        <label class="text-sm">Name
          <input id="md_name" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="Your Meme Token" />
        </label>
        <label class="text-sm">Symbol
          <input id="md_symbol" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="MEME" />
        </label>
        <label class="text-sm md:col-span-3">Description
          <input id="md_desc" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="Short description for wallets/explorers" />
        </label>
        <label class="text-sm md:col-span-2">External URL (optional)
          <input id="md_ext" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="https://yoursite.xyz" />
        </label>
        <label class="text-sm">Logo (PNG/JPG)
          <input id="md_img" type="file" accept="image/png,image/jpeg,image/jpg,image/webp" class="mt-1 w-full text-sm" />
        </label>
      </div>
      <div class="flex flex-wrap gap-3 mt-4">
        <button id="mdUpload" class="btn btn-ghost">1) Upload Image</button>
        <button id="mdSaveJson" class="btn btn-success">2) Save Metadata JSON</button>
        <button id="mdOnchain" class="btn btn-primary">3) Set On-Chain Metadata</button>
      </div>
      <pre id="md_out" class="hidden mt-3 bg-slate-950 border border-slate-800 rounded-xl p-3 overflow-x-auto"></pre>
      <div class="mt-4 flex justify-between">
        <button data-back="1" class="btn btn-ghost">‚Üê Back</button>
        <button id="next-2" class="btn btn-success">Next ‚Üí Security</button>
      </div>
    </section>

    <section id="step-3" class="card mt-6 hidden">
      <h2 class="text-xl font-semibold">Step 3 ‚Äî Security</h2>
      <p class="text-sm text-slate-400">Check mint authorities; renounce mint authority when ready. <span class="text-rose-300 font-semibold">Irreversible.</span></p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
        <label class="text-sm md:col-span-2">Mint
          <input id="sec_mint" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="Auto-filled from Step 1" />
        </label>
        <div class="flex gap-2">
          <button id="secCheck" class="btn btn-ghost mt-6 md:mt-auto">Check</button>
          <button id="secRenounce" class="btn btn-danger mt-6 md:mt-auto">Renounce Mint</button>
        </div>
      </div>
      <pre id="sec_out" class="hidden mt-3 bg-slate-950 border border-slate-800 rounded-xl p-3 overflow-x-auto"></pre>
      <div class="mt-4 flex justify-between">
        <button data-back="2" class="btn btn-ghost">‚Üê Back</button>
        <button id="next-3" class="btn btn-success">Next ‚Üí Raydium Plan</button>
      </div>
    </section>

    <section id="step-4" class="card mt-6 hidden">
      <h2 class="text-xl font-semibold">Step 4 ‚Äî Raydium Preflight</h2>
      <p class="text-sm text-slate-400">We compute the exact amounts and give you a checklist for Raydium‚Äôs permissionless UI.</p>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mt-4">
        <label class="text-sm">Your Mint <input id="ry_mint" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" /></label>
        <label class="text-sm">Decimals <input id="ry_dec" value="6" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" /></label>
        <label class="text-sm">Supply (tokens) <input id="ry_supply" value="1000000000" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" /></label>
        <label class="text-sm">% to LP <input id="ry_lp" value="8" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" /></label>
        <label class="text-sm">Price (USDC/token) <input id="ry_px" value="0.000001" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" /></label>
      </div>
      <button id="ryPlan" class="btn btn-primary mt-4">Compute Plan & Checklist</button>
      <pre id="ry_out" class="hidden mt-3 bg-slate-950 border border-slate-800 rounded-xl p-3 overflow-x-auto"></pre>
      <div class="mt-4 flex justify-between">
        <button data-back="3" class="btn btn-ghost">‚Üê Back</button>
        <button id="next-4" class="btn btn-success">Next ‚Üí Marketing</button>
      </div>
    </section>

    <section id="step-5" class="card mt-6 hidden">
      <h2 class="text-xl font-semibold">Step 5 ‚Äî Marketing & Launch Pack</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold">Marketing Generator</h3>
          <p class="text-sm text-slate-400">Tweet, Telegram, Discord, and a long description.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <label class="text-sm">Token Name <input id="mg_name" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="Your Meme Token" /></label>
            <label class="text-sm">Symbol <input id="mg_symbol" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="MEME" /></label>
            <label class="text-sm">Tier (SOL)
              <select id="mg_tier" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2">
                <option value="0.1">0.1</option><option value="0.5">0.5</option><option value="1">1</option><option value="2">2</option><option value="5">5</option>
              </select>
            </label>
            <label class="text-sm">Schedule (ISO-8601) <input id="mg_schedule" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="2025-08-14T20:00:00Z" /></label>
          </div>
          <button id="genBtn" class="btn btn-primary mt-3">Generate Content</button>
          <div id="mg_outputs" class="mt-4 space-y-4 hidden">
            <div><div class="flex items-center justify-between"><h4 class="font-medium">Tweet</h4><button data-copy="tweet" class="copy btn btn-ghost text-xs">Copy</button></div><pre id="tweet" class="mt-1 bg-slate-950 border border-slate-800 rounded-xl p-3"></pre></div>
            <div><div class="flex items-center justify-between"><h4 class="font-medium">Telegram</h4><button data-copy="tg" class="copy btn btn-ghost text-xs">Copy</button></div><pre id="tg" class="mt-1 bg-slate-950 border border-slate-800 rounded-xl p-3"></pre></div>
            <div><div class="flex items-center justify-between"><h4 class="font-medium">Discord Embed</h4><button data-copy="disc" class="copy btn btn-ghost text-xs">Copy</button></div><pre id="disc" class="mt-1 bg-slate-950 border border-slate-800 rounded-xl p-3"></pre></div>
            <div><div class="flex items-center justify-between"><h4 class="font-medium">Long Description</h4><button data-copy="desc" class="copy btn btn-ghost text-xs">Copy</button></div><pre id="desc" class="mt-1 bg-slate-950 border border-slate-800 rounded-xl p-3"></pre></div>
          </div>
        </div>
        <div>
          <h3 class="font-semibold">Export Launch Pack (.zip)</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
            <label class="text-sm">Token Name <input id="xp_name" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="Your Meme Token" /></label>
            <label class="text-sm">Symbol <input id="xp_symbol" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="MEME" /></label>
            <label class="text-sm">Mint Time <input id="xp_time" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="2025-08-14 20:00 UTC" /></label>
            <label class="text-sm">Pitch <input id="xp_pitch" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="Community-first fair launch on Solana." /></label>
          </div>
          <button id="xpBuild" class="btn btn-warn mt-3">Build Launch Pack</button>
          <div id="xp_out" class="hidden mt-3 text-sm text-emerald-300"></div>

          <h3 class="font-semibold mt-8">Affiliate Link (optional)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            <label class="text-sm md:col-span-2">Symbol <input id="af_symbol" class="mt-1 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2" placeholder="MEME" /></label>
            <button id="afBtn" class="btn btn-warn mt-6 md:mt-auto">Generate Ref Link</button>
          </div>
          <div id="af_out" class="hidden mt-3 text-sm text-slate-300"></div>
        </div>
      </div>
      <div class="mt-6 flex justify-between">
        <button data-back="4" class="btn btn-ghost">‚Üê Back</button>
        <span class="text-slate-400 text-sm">You‚Äôre launch-ready. Go get that green candle. üöÄ</span>
      </div>
    </section>

    <footer class="mt-10 text-center text-xs text-slate-500">¬© <span id="year"></span> pump.coin ‚Äî built for clarity.</footer>
  </div>

  <!-- App Script -->
  <script type="module">
    // ---- Imports (ESM) ----
    import {
      TOKEN_PROGRAM_ID, MINT_SIZE, getAssociatedTokenAddress,
      createAssociatedTokenAccountInstruction, createInitializeMint2Instruction,
      createMintToInstruction, getMint, createSetAuthorityInstruction, AuthorityType
    } from "https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.7/dist/index.browser.esm.min.js";

    import {
      PROGRAM_ID as TM_PROGRAM_ID,
      createCreateMetadataAccountV3Instruction,
      createUpdateMetadataAccountV2Instruction
    } from "https://esm.sh/@metaplex-foundation/mpl-token-metadata@2.10.6";

    const { SystemProgram, Connection, PublicKey, Transaction, Keypair } = solanaWeb3;

    // ---- Utils ----
    const $ = (id) => document.getElementById(id);
    $("year").textContent = new Date().getFullYear();
    const savedNet = localStorage.getItem("network") || "devnet";
    $("network").value = savedNet;
    $("network").addEventListener("change", e => localStorage.setItem("network", e.target.value));
    const netUrl = () => ($("network").value === "devnet" ? "https://api.devnet.solana.com" : "https://api.mainnet-beta.solana.com");

    // Wizard nav
    let currentStep = 1;
    function setStep(n){
      currentStep = n;
      for (let i=1;i<=5;i++){
        const sec = $(`step-${i}`); const nav = $(`nav-${i}`);
        if (i===n){ sec.classList.remove("hidden"); nav.classList.add("step-active"); }
        else { sec.classList.add("hidden"); nav.classList.remove("step-active"); }
        if (i<n) nav.classList.add("step-done"); else nav.classList.remove("step-done");
      }
      window.scrollTo({top:0, behavior:"smooth"});
    }
    document.querySelectorAll("[data-back]").forEach(btn => btn.addEventListener("click", e => setStep(parseInt(e.currentTarget.dataset.back,10))));
    $("next-1").onclick = ()=> setStep(2);
    $("next-2").onclick = ()=> setStep(3);
    $("next-3").onclick = ()=> setStep(4);
    $("next-4").onclick = ()=> setStep(5);

    setStep(1);

    // Phantom connect
    let walletAddr = null;
    $("connectBtn").onclick = async () => {
      const anyWin = window;
      if (!anyWin.solana || !anyWin.solana.isPhantom) { alert("Phantom not found."); return; }
      try {
        const resp = await anyWin.solana.connect();
        walletAddr = resp.publicKey.toString();
        $("addr").textContent = walletAddr.slice(0, 4) + "‚Ä¶" + walletAddr.slice(-4);
        const to = $("ct_to"); if (to) to.value = walletAddr;
        window.pumpWalletAddr = walletAddr;
      } catch (e) { console.error(e); alert("Wallet connection failed."); }
    };

    // Copy helpers
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".copy"); if (!btn) return;
      const el = $(btn.dataset.copy);
      if (el) navigator.clipboard.writeText(el.textContent).then(()=>{ btn.textContent="Copied"; setTimeout(()=>btn.textContent="Copy",800); });
    });

    // Global state
    let mintedMint = null;
    let lastImageUrl = null;
    let lastMetadataUrl = null;

    // ---- STEP 1: Create token (devnet) ----
    const ctOut = $("ct_out");
    function showCt(msg){ ctOut.innerHTML = msg; ctOut.classList.remove("hidden"); }
    $("ctBtn").onclick = async () => {
      if ($("network").value !== "devnet") { alert("In-app minting is enabled for DEVNET only."); return; }
      try {
        if (!walletAddr) return alert("Connect Phantom first.");
        const connection = new Connection(netUrl(), "confirmed");
        const payer = new PublicKey(walletAddr);
        const decimals = parseInt($("ct_decimals").value || "6", 10);
        const supplyTokens = BigInt($("ct_supply").value || "0");
        if (supplyTokens <= 0n) return alert("Supply must be a positive integer.");
        const amount = supplyTokens * (10n ** BigInt(decimals));

        const mint = Keypair.generate();
        const lamports = await connection.getMinimumBalanceForRentExemption(MINT_SIZE);
        const ixCreate = SystemProgram.createAccount({ fromPubkey: payer, newAccountPubkey: mint.publicKey, space: MINT_SIZE, lamports, programId: TOKEN_PROGRAM_ID });
        const ixInit   = createInitializeMint2Instruction(mint.publicKey, decimals, payer, null, TOKEN_PROGRAM_ID);
        const ata      = await getAssociatedTokenAddress(mint.publicKey, payer);
        const ixAta    = createAssociatedTokenAccountInstruction(payer, ata, payer, mint.publicKey);
        const ixMintTo = createMintToInstruction(mint.publicKey, ata, payer, amount);

        const tx = new Transaction().add(ixCreate, ixInit, ixAta, ixMintTo);
        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash; tx.feePayer = payer; tx.partialSign(mint);
        const sig = await window.solana.signAndSendTransaction(tx);
        const cluster = $("network").value;
        const link = `https://explorer.solana.com/tx/${sig.signature}?cluster=${cluster}`;
        mintedMint = mint.publicKey.toBase58();
        $("mintAddr").textContent = mintedMint;
        $("md_mint").value = mintedMint;
        $("sec_mint").value = mintedMint;
        $("ry_mint").value = mintedMint;
        showCt(`Mint created ‚úÖ<br/>Mint: <code>${mintedMint}</code><br/>ATA: <code>${ata.toBase58()}</code><br/>Tx: <a class="underline" target="_blank" href="${link}">view on explorer</a>`);
        setStep(2);
      } catch (e) { console.error(e); showCt("Mint failed. Make sure Phantom is unlocked and you have devnet SOL."); }
    };

    // ---- STEP 2: Metadata & Logo ----
    const mdOut = $("md_out"); const mdShow = (m)=>{ mdOut.textContent = typeof m==="string"? m : JSON.stringify(m,null,2); mdOut.classList.remove("hidden"); };
    $("mdUpload").onclick = async () => {
      const f = $("md_img").files[0]; if (!f) return alert("Choose an image first.");
      const dataUrl = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
      const resp = await fetch("/upload-asset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data_url:dataUrl})});
      const j = await resp.json(); if(!j.ok) return mdShow(j);
      lastImageUrl = j.url; mdShow({image_url:lastImageUrl});
    };
    $("mdSaveJson").onclick = async () => {
      if (!lastImageUrl) return alert("Upload an image first.");
      const resp = await fetch("/save-metadata",{method:"POST",headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          mint: ($("md_mint").value||"").trim(),
          name: $("md_name").value || "Your Meme Token",
          symbol: $("md_symbol").value || "MEME",
          description: $("md_desc").value || "",
          image_url: lastImageUrl,
          external_url: $("md_ext").value || "",
          attributes: []
        })});
      const j = await resp.json(); if(!j.ok) return mdShow(j);
      lastMetadataUrl = j.url; window.lastMetadataUrl = lastMetadataUrl; mdShow({metadata_url:lastMetadataUrl});
    };

    const findMetadataPda = (mintPk) =>
      PublicKey.findProgramAddressSync([Buffer.from("metadata"), TM_PROGRAM_ID.toBuffer(), mintPk.toBuffer()], TM_PROGRAM_ID)[0];

    $("mdOnchain").onclick = async () => {
      try {
        if (!walletAddr) return alert("Connect Phantom first.");
        const mintStr = ($("md_mint").value||"").trim(); if (!mintStr) return alert("Enter a mint address.");
        if (!lastMetadataUrl) return alert("Click '2) Save Metadata JSON' first.");
        const name = $("md_name").value || "Your Meme Token";
        const symbol = $("md_symbol").value || "MEME";
        const connection = new Connection(netUrl(), "confirmed");
        const payerPk = new PublicKey(walletAddr);
        const mintPk  = new PublicKey(mintStr);
        const metadataPda = findMetadataPda(mintPk);
        const exists = await connection.getAccountInfo(metadataPda);
        const tx = new Transaction();
        if (!exists) {
          tx.add(createCreateMetadataAccountV3Instruction(
            { metadata: metadataPda, mint: mintPk, mintAuthority: payerPk, payer: payerPk, updateAuthority: payerPk },
            { createMetadataAccountArgsV3: { data: { name, symbol, uri: lastMetadataUrl, sellerFeeBasisPoints: 0, creators: null, collection: null, uses: null }, isMutable: true, collectionDetails: null } }
          ));
        } else {
          tx.add(createUpdateMetadataAccountV2Instruction(
            { metadata: metadataPda, updateAuthority: payerPk },
            { updateMetadataAccountArgsV2: { data: { name, symbol, uri: lastMetadataUrl, sellerFeeBasisPoints: 0, creators: null, collection: null, uses: null }, updateAuthority: payerPk, primarySaleHappened: null, isMutable: true } }
          ));
        }
        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash; tx.feePayer = payerPk;
        const sig = await window.solana.signAndSendTransaction(tx);
        const cluster = $("network").value;
        mdShow({ onchain_metadata_tx: `https://explorer.solana.com/tx/${sig.signature}?cluster=${cluster}`, metadataPda: metadataPda.toBase58() });
        setStep(3);
      } catch (e) { console.error(e); mdShow("On-chain metadata failed."); }
    };

    // ---- STEP 3: Security ----
    const secOut = $("sec_out");
    $("secCheck").onclick = async () => {
      try {
        const mint = ($("sec_mint").value || "").trim(); if (!mint) return alert("Enter a mint.");
        const connection = new Connection(netUrl(), "confirmed");
        const info = await getMint(connection, new PublicKey(mint));
        secOut.textContent = JSON.stringify({
          mint, supply: info.supply.toString(), decimals: info.decimals,
          mintAuthority: info.mintAuthority ? info.mintAuthority.toBase58() : null,
          freezeAuthority: info.freezeAuthority ? info.freezeAuthority.toBase58() : null
        }, null, 2);
        secOut.classList.remove("hidden");
      } catch (e) { console.error(e); secOut.textContent = "Failed to fetch mint info."; secOut.classList.remove("hidden"); }
    };
    $("secRenounce").onclick = async () => {
      try {
        if (!walletAddr) return alert("Connect Phantom first.");
        const mint = ($("sec_mint").value || "").trim(); if (!mint) return alert("Enter a mint.");
        const connection = new Connection(netUrl(), "confirmed");
        const payer = new PublicKey(walletAddr);
        const mintPk = new PublicKey(mint);
        const ix = createSetAuthorityInstruction(mintPk, payer, AuthorityType.MintTokens, null, [], TOKEN_PROGRAM_ID);
        const tx = new Transaction().add(ix);
        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash; tx.feePayer = payer;
        const sig = await window.solana.signAndSendTransaction(tx);
        const cluster = $("network").value;
        secOut.textContent = JSON.stringify({ action:"Renounce MintTokens", tx:`https://explorer.solana.com/tx/${sig.signature}?cluster=${cluster}` }, null, 2);
        secOut.classList.remove("hidden");
      } catch (e) { console.error(e); secOut.textContent = "Renounce failed."; secOut.classList.remove("hidden"); }
    };

    // ---- STEP 4: Raydium plan ----
    $("ryPlan").onclick = async () => {
      const decimals = parseInt($("ry_dec").value || "6", 10);
      const supply = parseInt($("ry_supply").value || "0", 10);
      const lpPct = parseFloat($("ry_lp").value || "8");
      const price = parseFloat($("ry_px").value || "0.000001");
      const mint = ($("ry_mint").value || "").trim();
      const net = $("network").value;
      if (!mint) return alert("Enter your token mint.");
      if (supply <= 0) return alert("Supply must be positive.");
      const lpTokens = Math.floor(supply * (lpPct/100));
      const usdcNeeded = lpTokens * price;
      const fdv = supply * price;
      const plan = {
        network: net, token_mint: mint, token_decimals: decimals,
        lp_tokens_to_deposit: lpTokens, estimated_usdc_to_deposit: +usdcNeeded.toFixed(6),
        initial_pool_value_usd: +(usdcNeeded*2).toFixed(2), implied_fdv_usd: +fdv.toFixed(2),
        checklist: [
          "1) Ensure wallet has SOL for fees.",
          `2) Hold at least ${lpTokens.toLocaleString()} tokens for LP.`,
          `3) Fund ~${usdcNeeded.toFixed(6)} USDC.`,
          "4) Create ATAs for token & USDC if missing.",
          "5) Use Raydium permissionless pool creator: Token ‚Üî USDC.",
          "6) Deposit exactly the amounts above. Confirm.",
          "7) Optional: renounce mint authority when ready."
        ]
      };
      const out = $("ry_out"); out.textContent = JSON.stringify(plan, null, 2); out.classList.remove("hidden");
    };

    // ---- STEP 5: Marketing / Pack / Affiliates ----
    $("genBtn").onclick = async () => {
      const body = {
        token_name: $("mg_name").value || "Your Meme Token",
        symbol: $("mg_symbol").value || "MEME",
        tier_sol: parseFloat($("mg_tier").value || "0.5"),
        schedule_iso: $("mg_schedule").value || null,
        network: $("network").value || "devnet",
      };
      const res = await fetch("/generate", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body) });
      const json = await res.json();
      $("tweet").textContent = json.tweet || "";
      $("tg").textContent = json.telegram_message || "";
      $("disc").textContent = `TITLE: ${json.discord_embed?.title || ""}\n\n${json.discord_embed?.description || ""}`;
      $("desc").textContent = json.description || "";
      $("mg_outputs").classList.remove("hidden");
    };

    $("xpBuild").onclick = async () => {
      const zip = new JSZip();
      const name = $("xp_name").value || $("mg_name").value || "Your Meme Token";
      const symbol = $("xp_symbol").value || $("mg_symbol").value || "MEME";
      const when = $("xp_time").value || $("mg_schedule").value || "TBA";
      const pitch = $("xp_pitch").value || "Community-first fair launch on Solana.";
      const net = $("network").value;
      const genBody = { token_name: name, symbol, tier_sol: parseFloat($("mg_tier").value || "0.5"), schedule_iso: $("mg_schedule").value || null, network: net };
      const gen = await (await fetch("/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(genBody)})).json();
      const microsite = await (await fetch("/prelaunch",{method:"POST",headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ token_name: name, symbol, pitch, mint_time: when, network: net })})).json();

      zip.file("launch/README.md",
`# ${name} ($${symbol}) ‚Äî Launch Pack
- tweet.txt ‚Äî X post
- telegram.html ‚Äî paste to Telegram
- discord.md ‚Äî paste to Discord
- microsite.html ‚Äî static page
- metadata.json ‚Äî wallet/explorer metadata
- logo.(png|jpg|webp) ‚Äî token logo
`);
      zip.file("launch/tweet.txt", gen.tweet || "");
      zip.file("launch/telegram.html", gen.telegram_message || "");
      zip.file("launch/discord.md", (gen.discord_embed?.title || "") + "\n\n" + (gen.discord_embed?.description || ""));
      zip.file("launch/microsite.html", microsite.html || "<!-- no microsite -->");

      if (lastMetadataUrl) { try { const t = await (await fetch(lastMetadataUrl)).text(); zip.file("launch/metadata.json", t); } catch {} }
      if (lastImageUrl)   { try { const b = await (await fetch(lastImageUrl)).blob(); const ext = (lastImageUrl.split(".").pop()||"png").split("?")[0]; zip.file(`launch/logo.${ext}`, b); } catch {} }

      const content = await zip.generateAsync({type:"blob"});
      saveAs(content, `${symbol}-launch-pack.zip`);
      const out = $("xp_out"); out.textContent = `Launch pack created: ${symbol}-launch-pack.zip`; out.classList.remove("hidden");
    };

    $("afBtn").onclick = async () => {
      const symbol = $("af_symbol").value || "MEME";
      const res = await fetch("/ref-link",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol})});
      const json = await res.json();
      const out = $("af_out"); out.innerHTML = `Link: <a href="${json.link}" class="underline" target="_blank">${json.link}</a> ‚Ä¢ Code: ${json.code} ‚Ä¢ Share: ${Math.round(json.share*100)}%`; out.classList.remove("hidden");
    };
  </script>
</body>
</html>
